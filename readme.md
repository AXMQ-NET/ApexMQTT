# AXMQ (ApexMQTT) | é¼Žæž

[![License](https://img.shields.io/badge/License-Proprietary-red.svg)](LICENSE)
[![Go Version](https://img.shields.io/badge/Go-1.24+-00ADD8.svg?style=flat&logo=go)](https://golang.org)
[![Official Website](https://img.shields.io/badge/Official-axmq.net-blue.svg)](http://axmq.net)

**AXMQ (ApexMQTT / é¼Žæž)** æ˜¯ä¸€æ¬¾é¢å‘ç™¾ä¸‡çº§è®¾å¤‡æŽ¥å…¥ã€åƒä¸‡çº§æ¶ˆæ¯åˆ†å‘è€Œç”Ÿçš„æžè‡´é«˜æ€§èƒ½ MQTT ä»£ç†ï¼ˆBrokerï¼‰ã€‚åŸºäºŽ Go è¯­è¨€æž„å»ºï¼Œé€šè¿‡å¯¹åº•å±‚ç½‘ç»œæ ˆã€å†…å­˜åˆ†é…å’Œå¹¶å‘æ¨¡åž‹çš„æ·±åº¦é‡æž„ï¼ŒAXMQ æˆåŠŸçªç ´äº†å•æœºæ€§èƒ½çš„ç‰©ç†å¤©èŠ±æ¿ã€‚

## ðŸš€ æ ¸å¿ƒä¼˜åŠ¿ (Top-Tier Performance)

- **å•æœºç™¾ä¸‡è¿žæŽ¥ (Million Connections):** åœ¨å•æœºçŽ¯å¢ƒä¸‹ç¨³å®šæ”¯æ’‘ 100 ä¸‡ä¸ªæ´»è·ƒé•¿è¿žæŽ¥ï¼Œç¨³æ€å†…å­˜å ç”¨ä»…çº¦ 4.4GBã€‚
- **åƒä¸‡çº§åˆ†å‘ (High Throughput):** æ¶ˆæ¯åˆ†å‘åžåé‡é«˜è¾¾ **260 ä¸‡æ¡/ç§’ (QoS 0)**ï¼Œå‡ºç«™å¸¦å®½å³°å€¼å¯è¾¾ 5.81 Gbpsã€‚
- **é›¶æ‹·è´è·¯å¾„ (Zero-Copy):** åŸºäºŽ `writev` å‘é‡åŒ– I/Oï¼Œå®žçŽ°ä»Žå…¥å£åˆ°å‡ºå£çš„å…¨è·¯å¾„é›¶æ‹·è´æ¶ˆæ¯åˆ†å‘ã€‚
- **å¤šæ ¸å¼‚æ­¥ I/O (Multi-Core Sharded I/O):** è‡ªç ” `pollio` å¼•æ“Žï¼Œé‡‡ç”¨æ— ç«žäº‰åˆ†ç‰‡æž¶æž„ï¼Œå½»åº•æ¶ˆé™¤é«˜å¹¶å‘ä¸‹çš„é”ç«žäº‰ä¸Žåç¨‹è°ƒåº¦å¼€é”€ã€‚
- **åˆ†çº§ Slab å†…å­˜æ±  (Slab MemPool):** ç»•è¿‡ Go åŽŸç”Ÿå †ç®¡ç†ï¼Œé€šè¿‡è‡ªç ” Slab å†…å­˜æ± å°†å †å¯¹è±¡æ•°é‡é™ä½Ž 90% ä»¥ä¸Šï¼Œæžå¤§ç¼“è§£ GC åŽ‹åŠ›ã€‚

## âš¡ å¿«é€Ÿå¼€å§‹ (Quick Start)

### 1. ä¸‹è½½ç¨‹åº
ä»Ž GitHub Releases é¡µé¢ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆ`ApexMQTT_amd64_linux`ï¼‰ä»¥åŠé»˜è®¤é…ç½®æ–‡ä»¶ `conf.yml`ã€‚

### 2. å‡†å¤‡é…ç½®
ç¡®ä¿äºŒè¿›åˆ¶æ–‡ä»¶ä¸Ž `conf.yml` å¤„äºŽåŒä¸€ç›®å½•ä¸‹ã€‚ä½ å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ `conf.yml` ä¸­çš„ç«¯å£å’Œå†…å­˜é™åˆ¶ã€‚

### 3. å¯åŠ¨ç¨‹åº
ç”±äºŽ AXMQ ä¼šåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨å°è¯•ä¼˜åŒ– Linux å†…æ ¸ç½‘ç»œå‚æ•°ï¼ˆå¦‚å¥æŸ„æ•°ã€ç¼“å†²åŒºå¤§å°ç­‰ï¼‰ï¼Œå»ºè®®ä»¥ **root** æƒé™è¿è¡Œï¼š
```bash
chmod +x ApexMQTT_amd64_linux
sudo ./ApexMQTT_amd64_linux
```

## âš™ï¸ é…ç½®è¯´æ˜Ž (Configuration)

ç¼–è¾‘ `conf.yml` æ–‡ä»¶ä»¥é€‚é…æ‚¨çš„æœåŠ¡å™¨çŽ¯å¢ƒï¼š

- `dashboard_pass`: Web ç®¡ç†åŽå°ç™»å½•å¯†ç ã€‚ç•™ç©ºåˆ™ç¨‹åºå¯åŠ¨æ—¶éšæœºç”Ÿæˆ 8 ä½å¯†ç ã€‚
- `max_memory_gb`: æœåŠ¡å™¨å¯åˆ†é…ç»™ AXMQ çš„æœ€å¤§å†…å­˜ï¼ˆGBï¼‰ã€‚ç¨‹åºä¼šæ®æ­¤è‡ªåŠ¨é…ç½®å†…å­˜ä¿æŠ¤é˜ˆå€¼ã€‚
- `storage_path`: æ¶ˆæ¯æŒä¹…åŒ–ï¼ˆQoS 1/2 ç¦»çº¿æ¶ˆæ¯ï¼‰çš„å­˜å‚¨è·¯å¾„ï¼Œä¸€èˆ¬ä¿æŒé»˜è®¤å³å¯ã€‚
- `host`: MQTT TCP æœåŠ¡ç›‘å¬åœ°å€ï¼ˆé»˜è®¤ `:1883`ï¼‰ã€‚
- `websocket_host`: WebSocket æœåŠ¡ç›‘å¬åœ°å€ï¼ˆé»˜è®¤ `:8083`ï¼‰ã€‚
- `*_tls_pem/key`: é…ç½® TLS è¯ä¹¦è·¯å¾„ä»¥å¼€å¯åŠ å¯†ä¼ è¾“ï¼Œä¸€ä½†é…ç½®è¯ä¹¦å³é»˜è®¤ä»¥è¯ä¹¦åŠ å¯†è¿žæŽ¥è¿è¡ŒäºŽæŒ‡å®šçš„hostç«¯å£ã€‚

## ðŸ–¥ï¸ ç®¡ç†åŽå° (Web Dashboard)

AXMQ å†…ç½®äº† Web ç®¡ç†åŽå°ï¼Œæ— éœ€é¢å¤–å®‰è£…å³å¯ä½¿ç”¨ã€‚

### 1. è®¿é—®åœ°å€
ç¨‹åºå¯åŠ¨åŽï¼Œé€šè¿‡æµè§ˆå™¨è®¿é—®ï¼š`http://æœåŠ¡å™¨IP` (é»˜è®¤ä½¿ç”¨ 80 ç«¯å£ï¼Œæ‰€ä»¥ä¸éœ€è¦è¾“å…¥ç«¯å£å·)ã€‚

### 2. èŽ·å–å¯†ç 
å¦‚æžœä½ åœ¨ `conf.yml` ä¸­æœªè®¾ç½®å¯†ç ï¼Œè¯·åœ¨å¯åŠ¨åŽçš„æŽ§åˆ¶å°è¾“å‡ºä¸­å¯»æ‰¾å¦‚ä¸‹æ—¥å¿—ï¼š
`Dashboard starting on http://:80 (Login Password: xxxxxxxx)`
å¤åˆ¶è¯¥ 8 ä½éšæœºå¯†ç è¿›è¡Œç™»å½•ã€‚

### 3. åŠŸèƒ½æ¦‚è§ˆ
- **çŠ¶æ€æ¦‚è§ˆ (Overview)**: å®žæ—¶å¯è§†åŒ–ç›‘æŽ§ Broker çš„è¿è¡ŒçŠ¶æ€ã€è¿žæŽ¥æ•°ã€æ¶ˆæ¯é€ŸçŽ‡åŠå†…å­˜åˆ†å¸ƒã€‚
- **è¿žæŽ¥ç®¡ç† (Clients)**: å®žæ—¶åˆ—å‡ºæ‰€æœ‰åœ¨çº¿å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œæ”¯æŒæŸ¥çœ‹ IP åœ°å€å¹¶æ‰‹åŠ¨å¼ºåˆ¶æ–­å¼€ï¼ˆKick Outï¼‰ã€‚
- **ç­–ç•¥å¼•æ“Ž (Policies)**: åŠ¨æ€é…ç½®è®¤è¯ç­–ç•¥ï¼ˆæ”¯æŒ JWTã€Basic Authç­‰æ”¯æŒè§„åˆ™å¼•æ“Žï¼‰ï¼Œå®žçŽ°æ¯«ç§’çº§ç­–ç•¥ä¸‹å‘ã€‚
- **ä¿ç•™æ¶ˆæ¯ (Retained)**: é›†ä¸­å±•ç¤ºç³»ç»Ÿä¸­å½“å‰å­˜å‚¨çš„æ‰€æœ‰ä¿ç•™æ¶ˆæ¯ï¼Œæ”¯æŒæŒ‰ä¸»é¢˜æ£€ç´¢ä¸Žæ¸…ç†ã€‚
- **å®‰å…¨æ‹¦æˆª (Blocker)**: ç›‘æŽ§å¹¶ç®¡ç†è¢« `IpBlocker` è‡ªåŠ¨å°ç¦çš„æ¶æ„ IPï¼Œæ”¯æŒæ‰‹åŠ¨å°ç¦æˆ–è§£å°ã€‚
- **åŠ¨æ€é…ç½® (Config)**: å®žæ—¶è°ƒæ•´æœ€å¤§åŒ…å¤§å°ã€å°ç¦æ—¶é•¿ç­‰ç³»ç»Ÿæ ¸å¿ƒå‚æ•°ï¼Œæ— éœ€é‡å¯å³å¯ç”Ÿæ•ˆã€‚

## ðŸ›  æŠ€æœ¯ç‰¹æ€§

- **å¤šæ ¸å¿ƒåˆ†ç‰‡:** æ ¹æ® CPU æ ¸å¿ƒæ•°åŠ¨æ€åˆ†é… Poller å®žä¾‹ï¼Œå¹¶è¿›è¡Œçº¿ç¨‹ç»‘å®šã€‚
- **ä»»åŠ¡æ± éš”ç¦»:** æŽ§åˆ¶é¢ï¼ˆæ¡æ‰‹/è®¢é˜…ï¼‰ä¸Žæ•°æ®é¢ï¼ˆå‘å¸ƒ/å¿ƒè·³ï¼‰ä»»åŠ¡ç‰©ç†éš”ç¦»ï¼Œç¡®ä¿åŽ‹åŠ›ä¸‹è¿žæŽ¥ä¸ä¸­æ–­ã€‚
- **é«˜æ€§èƒ½ä¸»é¢˜å¼•æ“Ž:** é‡‡ç”¨ $O(1)$ ç²¾ç¡®åŒ¹é…ä¸Žè¿­ä»£å¼é€šé…ç¬¦åŒ¹é…ç®—æ³•ï¼Œæ”¯æŒç™¾ä¸‡çº§è®¢é˜…ã€‚
- **é«˜å®‰å…¨æ€§:** æ”¯æŒ TLS/SSL åŠ å¯†ï¼Œå†…ç½® IP æ‹¦æˆªå™¨ (`IpBlocker`) é˜²èŒƒæ¶æ„æ”»å‡»ã€‚
- **WebSocket æ”¯æŒ:** åŽŸç”Ÿæ”¯æŒé«˜æ€§èƒ½ WebSocket æŽ¥å…¥ï¼Œé€‚é…å¤šç§ Web åº”ç”¨åœºæ™¯ã€‚
- **è‡ªåŠ¨åŒ–è°ƒä¼˜:** å¯åŠ¨æ—¶è‡ªåŠ¨ä¼˜åŒ– Linux å†…æ ¸ç½‘ç»œå‚æ•°ï¼ˆwmem/rmem/somaxconn ç­‰ï¼‰ã€‚

## ðŸ“– åŠŸèƒ½è¯´æ˜Ž (Functional Guide)

AXMQ ä¸¥æ ¼éµå¾ª MQTT 3.1.1 åè®®è§„èŒƒï¼Œå¹¶é’ˆå¯¹å¤§è§„æ¨¡ IOT åœºæ™¯è¿›è¡Œäº†æ‰©å±•ã€‚

### 1. å…±äº«è®¢é˜… (Shared Subscription)
åœ¨é«˜å¹¶å‘åˆ†å‘åœºæ™¯ä¸‹ï¼ŒAXMQ æ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯å…±äº«åŒä¸€ä¸ªè®¢é˜…æµï¼Œå®žçŽ°è´Ÿè½½å‡è¡¡ã€‚
- **ç”¨æ³•:** ä½¿ç”¨ `$share/{group}/{topic}` æ ¼å¼è®¢é˜…ã€‚
- **ç¤ºä¾‹:** ä¸¤ä¸ªå®¢æˆ·ç«¯åŒæ—¶è®¢é˜… `$share/g1/sensor/data`ï¼Œå‘é€åˆ° `sensor/data` çš„æ¶ˆæ¯å°†ä»¥è½®è¯¢æ–¹å¼åœ¨ä¸¤è€…ä¹‹é—´åˆ†å‘ã€‚

### 2. ç³»ç»Ÿç»Ÿè®¡ä¸»é¢˜ ($SYS Topics)
AXMQ æä¾›ç¬¦åˆè¡Œä¸šæƒ¯ä¾‹çš„ç³»ç»Ÿç»Ÿè®¡ä¸»é¢˜ï¼Œç”¨äºŽå®žæ—¶ç›‘æŽ§ Broker çš„è¿è¡ŒçŠ¶æ€ã€‚
- **ç‰¹æ€§:** é‡‡ç”¨ `Retain` æœºåˆ¶ï¼Œå®¢æˆ·ç«¯è®¢é˜…åŽå¯ç«‹å³èŽ·å–ç»Ÿè®¡å¿«ç…§ã€‚
- **æ ¸å¿ƒä¸»é¢˜:**
  - `$SYS/broker/version`: Broker ç‰ˆæœ¬å·ã€‚
  - `$SYS/broker/uptime`: ç³»ç»Ÿè¿è¡Œæ€»æ—¶é•¿ã€‚
  - `$SYS/broker/clients/connected`: å½“å‰åœ¨çº¿å®¢æˆ·ç«¯æ€»æ•°ã€‚
  - `$SYS/broker/clients/total`: åŽ†å²ç´¯è®¡è¿žæŽ¥æ€»æ•°ã€‚
  - `$SYS/broker/messages/received`: ç´¯è®¡æŽ¥æ”¶çš„æ¶ˆæ¯æ€»æ•°ã€‚
  - `$SYS/broker/messages/sent`: ç´¯è®¡å‘é€çš„æ¶ˆæ¯æ€»æ•°ã€‚
  - `$SYS/broker/subscriptions/count`: å½“å‰æ´»è·ƒè®¢é˜…æ€»æ•°ã€‚

### 3. å…¶ä»–
- **å…¶ä»–æœªç‰¹åˆ«è¯´æ˜Žéƒ¨åˆ†:** å®Œå…¨éµå®ˆMQTT3.1.1åè®®è§„èŒƒåŠŸèƒ½å®Œå¤‡ã€‚
- **åŠŸèƒ½å®Œå¤‡æ€§æµ‹è¯•ç”¨ä¾‹:** æä¾›åŠŸèƒ½å®Œå¤‡æ€§å•å…ƒæµ‹è¯•ç”¨ä¾‹,æµ‹è¯•æŒ‡ä»¤å¦‚ä¸‹ã€‚
```bash
go test -v mqtt_functional_test.go mqtt_raw_helpers_test.go
```

## ðŸ“ˆ æ€§èƒ½è¡¨çŽ°

### æµ‹è¯•åŸºç¡€çŽ¯å¢ƒ (Benchmark Infrastructure)
ä»¥ä¸Šæ€§èƒ½æ•°æ®åŸºäºŽä»¥ä¸‹çŽ¯å¢ƒæµ‹å¾—ï¼Œé‡‡ç”¨ A/B åŒæœºæµ‹è¯•æ¨¡åž‹ï¼š
- **äº‘æœåŠ¡å•†:** é˜¿é‡Œäº‘ (Alibaba Cloud)
- **ç½‘ç»œçŽ¯å¢ƒ:** ECS å†…ç½‘çŽ¯å¢ƒ
- **æœåŠ¡å™¨é…ç½® (Aæœº/Broker):** 24 æ ¸ CPU, 48GB å†…å­˜, NVMe SSD 40G æŒä¹…åŒ–å­˜å‚¨
- **æµ‹è¯•æ¨¡åž‹:** A æœºä½œä¸ºç›®æ ‡ Brokerï¼ŒB æœºä½œä¸ºåŽ‹åŠ›æº (128æ ¸ 256G) æ¨¡æ‹Ÿç™¾ä¸‡çº§è¿žæŽ¥ä¸Žé«˜é¢‘åžå

| æµ‹è¯•ç»´åº¦ | æ€§èƒ½æŒ‡æ ‡ (Metrics) | æµ‹å¾—å³°å€¼ (Peak Performance) | å¤‡æ³¨                   |
| :--- | :--- |:------------------------|:---------------------|
| **åˆ†å‘æ€§èƒ½** | QoS 0 æ¶ˆæ¯åžå | **2,600,000+ msg/s**    | å¤šæ ¸å¼‚æ­¥ I/O å¼•æ“Ž          |
| | QoS 1 æ¶ˆæ¯åžå | **480,000+ msg/s**      | å¼€å¯ç£ç›˜æŒä¹…åŒ–ä¸ŽçŠ¶æ€åŒæ­¥         |
| | QoS 2 æ¶ˆæ¯åžå | **155,000+ msg/s**      | ä¸¥æ ¼éµå¾ªå››é˜¶æ®µæ¡æ‰‹æµç¨‹          |
| **å¸¦å®½èƒ½åŠ›** | ç½‘ç»œå‡ºç«™å¸¦å®½ | **5.81 Gbps**           | é˜¿é‡Œäº‘å†…ç½‘å¸¦å®½å³°å€¼åˆ†å‘          |
| | åº”ç”¨å±‚åˆ†å‘é€ŸçŽ‡ | **2.2 GB/s**            | å…¨é“¾è·¯é›¶æ‹·è´å†…å­˜è·¯å¾„           |
| **å†…å­˜ç®¡ç†** | 1,000,000 è¿žæŽ¥å†…å­˜ | **~4.4 GB**             | å‡æ‘Š 4.4KB/è¿žæŽ¥ (æžç®€è®¾è®¡)   |
| | å†…å­˜æ›²çº¿ | **æžåº¦å¹³ç¨³**                | è‡ªç ” Slab Pool ç»•è¿‡åŽŸç”Ÿ GC |

## åŽ‹åŠ›æµ‹è¯•è¿‡ç¨‹ï¼Œæ•¬è¯·æœŸå¾…ã€ŠAXMQ (ApexMQTT / é¼Žæž)ç™½çš®ä¹¦ã€‹

## ðŸŒ å®˜æ–¹èµ„æº

- **å®˜ç½‘:** [axmq.net](http://axmq.net)
- **è”ç³»æˆ‘ä»¬:** é»Žä¸œæµ· (Email: 229292620@qq.com)

---

> **åœ¨æ¯«ç§’è¢«å®šä¹‰ä¹‹å‰ï¼Œä¸‡ç‰©å·²ç„¶æŠµè¾¾ã€‚**
> **Arrival, Before the Millisecond Begins.**
